<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>筆電異音分析儀 (Laptop Noise Analyzer)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            /* 防止手機下拉重整干擾 App 操作 */
            overscroll-behavior-y: none; 
        }
        /* 隱藏捲軸但保持滾動功能 (針對 Webkit) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-[100dvh] w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons Components ---
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Activity = (props) => (
            <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>
        );
        const Play = (props) => (
            <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>
        );
        const Square = (props) => (
            <IconBase {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></IconBase>
        );
        const RefreshCcw = (props) => (
            <IconBase {...props}>
                <path d="M3 2v6h6"></path>
                <path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path>
                <path d="M21 22v-6h-6"></path>
                <path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path>
            </IconBase>
        );
        const Mic = (props) => (
            <IconBase {...props}>
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </IconBase>
        );
        const MapPin = (props) => (
            <IconBase {...props}>
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </IconBase>
        );
        const Settings = (props) => (
            <IconBase {...props}>
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </IconBase>
        );

        // --- Main Component ---
        const LaptopNoiseAnalyzer = () => {
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [decibels, setDecibels] = useState(-100);
            const [peakFreq, setPeakFreq] = useState(0);
            const [gain, setGain] = useState(1.5);
            const [showSettings, setShowSettings] = useState(false);
            
            // Heatmap state: 3x4 grid
            const [gridData, setGridData] = useState(Array(12).fill(null));
            
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const rafIdRef = useRef(null);
            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const gainNodeRef = useRef(null);

            // RWD Canvas Logic
            useEffect(() => {
                const handleResize = () => {
                    if (canvasRef.current && containerRef.current) {
                        // Match canvas internal resolution to CSS size for crisp lines
                        canvasRef.current.width = containerRef.current.clientWidth;
                        canvasRef.current.height = containerRef.current.clientHeight;
                    }
                };
                
                window.addEventListener('resize', handleResize);
                handleResize(); // Init
                
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const startAnalysis = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const analyser = audioContextRef.current.createAnalyser();
                    analyser.fftSize = 1024; // Smaller FFT for faster reaction on mobile
                    analyser.smoothingTimeConstant = 0.8;
                    analyserRef.current = analyser;

                    const gainNode = audioContextRef.current.createGain();
                    gainNode.gain.value = gain;
                    gainNodeRef.current = gainNode;

                    const source = audioContextRef.current.createMediaStreamSource(stream);
                    source.connect(gainNode);
                    gainNode.connect(analyser);
                    
                    setIsAnalyzing(true);
                    drawSpectrum();
                } catch (err) {
                    console.error("Mic Error:", err);
                    alert("無法存取麥克風。請確認：\n1. 瀏覽器權限已允許\n2. 使用 HTTPS 或 Localhost\n3. 手機未靜音");
                }
            };

            const stopAnalysis = () => {
                if (audioContextRef.current && audioContextRef.current.state !== 'closed') {
                    audioContextRef.current.close();
                }
                if (rafIdRef.current) {
                    cancelAnimationFrame(rafIdRef.current);
                }
                setIsAnalyzing(false);
                setDecibels(-100);
                setPeakFreq(0);
            };

            const updateGain = (val) => {
                setGain(val);
                if (gainNodeRef.current) {
                    gainNodeRef.current.gain.value = val;
                }
            };

            const drawSpectrum = () => {
                const canvas = canvasRef.current;
                if (!canvas || !analyserRef.current) return;

                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                analyserRef.current.getByteFrequencyData(dataArray);

                // Background
                ctx.fillStyle = '#0f172a'; // Darker slate
                ctx.fillRect(0, 0, width, height);

                // Stats Calculation
                let maxVal = -Infinity;
                let maxIndex = 0;
                let sum = 0;

                // Drawing settings
                const barWidth = (width / bufferLength) * 2.0; 
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i];
                    
                    if (v > maxVal) {
                        maxVal = v;
                        maxIndex = i;
                    }
                    sum += v * v;

                    const percent = v / 255;
                    const barHeight = height * percent;
                    
                    // Gradient-like coloring
                    const hue = 200 + (i / bufferLength) * 160; // Blue to Red range
                    ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;
                    
                    // Rounded caps looks better on mobile
                    ctx.fillRect(x, height - barHeight, barWidth, barHeight);
                    x += barWidth + 0.5;
                }

                // Update UI state (Throttled could be better but Raf is OK for this simple app)
                const rms = Math.sqrt(sum / bufferLength);
                const db = 20 * Math.log10(rms / 255);
                setDecibels(Math.max(-100, Math.round(db * 10) / 10)); // 1 decimal

                const nyquist = audioContextRef.current.sampleRate / 2;
                const frequency = maxIndex * (nyquist / bufferLength);
                setPeakFreq(Math.round(frequency));

                rafIdRef.current = requestAnimationFrame(drawSpectrum);
            };

            const recordPoint = (index) => {
                if (!isAnalyzing) {
                    alert("請先點擊上方「開始」按鈕");
                    return;
                }
                
                const newGrid = [...gridData];
                // Mobile tuning: slightly more sensitive visualization
                let intensity = (decibels + 50) * 2.5; 
                intensity = Math.max(0, Math.min(100, intensity));

                newGrid[index] = {
                    db: decibels,
                    freq: peakFreq,
                    intensity: intensity
                };
                setGridData(newGrid);
            };

            const clearGrid = () => setGridData(Array(12).fill(null));

            const getCellStyles = (cell) => {
                const base = "relative w-full h-full rounded-xl flex flex-col items-center justify-center transition-all duration-200 active:scale-95 touch-manipulation shadow-sm ";
                
                if (!cell) return base + "bg-white border-2 border-dashed border-slate-200 active:border-blue-400 active:bg-blue-50";
                
                const { intensity } = cell;
                if (intensity < 30) return base + "bg-emerald-100 border-2 border-emerald-400 text-emerald-800";
                if (intensity < 60) return base + "bg-amber-100 border-2 border-amber-400 text-amber-800";
                return base + "bg-rose-100 border-2 border-rose-500 text-rose-800 animate-pulse";
            };

            return (
                <div className="flex flex-col h-full bg-slate-50 font-sans select-none">
                    {/* 1. Header & Controls (Compact) */}
                    <div className="flex-none bg-white px-4 py-3 shadow-sm flex items-center justify-between z-10">
                        <div className="flex items-center gap-2">
                            <div className="bg-blue-600 p-1.5 rounded-lg text-white">
                                <Activity size={18} />
                            </div>
                            <h1 className="font-bold text-slate-800 text-lg leading-none">
                                機構異音分析
                                <span className="block text-[10px] text-slate-400 font-normal mt-0.5">Mobile Analyzer</span>
                            </h1>
                        </div>
                        <div className="flex gap-2">
                            <button 
                                onClick={() => setShowSettings(!showSettings)}
                                className={`p-2 rounded-lg transition-colors ${showSettings ? 'bg-slate-100 text-slate-800' : 'text-slate-400'}`}
                            >
                                <Settings size={20} />
                            </button>
                            {!isAnalyzing ? (
                                <button onClick={startAnalysis} className="flex items-center gap-1 px-4 py-2 bg-blue-600 text-white rounded-lg shadow-blue-200 shadow-md active:bg-blue-700 font-bold text-sm">
                                    <Play size={16} /> 開始
                                </button>
                            ) : (
                                <button onClick={stopAnalysis} className="flex items-center gap-1 px-4 py-2 bg-rose-500 text-white rounded-lg shadow-rose-200 shadow-md active:bg-rose-600 font-bold text-sm">
                                    <Square size={16} /> 停止
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Gain Setting (Collapsible) */}
                    {showSettings && (
                        <div className="flex-none bg-slate-100 px-4 py-3 border-b border-slate-200 animate-fade-in">
                            <div className="flex items-center justify-between text-xs text-slate-500 mb-1">
                                <span>麥克風靈敏度 (Gain)</span>
                                <span className="font-mono">{gain.toFixed(1)}x</span>
                            </div>
                            <input 
                                type="range" min="0.5" max="5.0" step="0.1" 
                                value={gain} 
                                onChange={(e) => updateGain(parseFloat(e.target.value))}
                                className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-blue-600"
                            />
                        </div>
                    )}

                    {/* 2. Visualizer (Top Part) */}
                    <div className="flex-none h-48 sm:h-64 relative bg-slate-900 w-full overflow-hidden" ref={containerRef}>
                        <canvas ref={canvasRef} className="w-full h-full block" />
                        
                        {/* Overlay Stats */}
                        <div className="absolute top-2 left-3 right-3 flex justify-between items-start pointer-events-none">
                            <div className="bg-black/40 backdrop-blur-sm px-2 py-1 rounded text-xs text-slate-300 font-mono">
                                <div className="flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-blue-400 inline-block"></span>
                                    {peakFreq} Hz
                                </div>
                            </div>
                            <div className="bg-black/40 backdrop-blur-sm px-2 py-1 rounded text-xs text-slate-300 font-mono">
                                <div className="flex items-center gap-2">
                                    <span className={`w-2 h-2 rounded-full inline-block ${decibels > -30 ? 'bg-red-500' : 'bg-green-400'}`}></span>
                                    {decibels} dB
                                </div>
                            </div>
                        </div>

                        {!isAnalyzing && (
                            <div className="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-[1px]">
                                <p className="text-white/80 text-sm flex items-center gap-2 border border-white/20 px-3 py-1.5 rounded-full">
                                    <Mic size={14} /> 請點擊右上角「開始」
                                </p>
                            </div>
                        )}
                    </div>

                    {/* 3. Heatmap Grid (Bottom Part - Fills remaining space) */}
                    <div className="flex-1 flex flex-col bg-white rounded-t-2xl -mt-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-0 overflow-hidden relative">
                        {/* Toolbar */}
                        <div className="flex-none px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                            <h2 className="text-sm font-bold text-slate-700 flex items-center gap-1.5">
                                <MapPin size={16} className="text-rose-500" />
                                異音定位 (C-Cover)
                            </h2>
                            <button onClick={clearGrid} className="text-slate-400 p-1.5 hover:bg-slate-50 rounded-full transition-colors" title="重置">
                                <RefreshCcw size={16} />
                            </button>
                        </div>

                        {/* Grid Area */}
                        <div className="flex-1 p-3 overflow-y-auto no-scrollbar">
                            <div className="h-full w-full max-w-md mx-auto grid grid-cols-3 grid-rows-4 gap-2 pb-safe">
                                {gridData.map((cell, idx) => (
                                    <div key={idx} onClick={() => recordPoint(idx)} className="w-full h-full min-h-[60px]">
                                        <div className={getCellStyles(cell)}>
                                            {cell ? (
                                                <>
                                                    <span className="text-xl font-bold leading-none">{cell.db.toFixed(0)}</span>
                                                    <span className="text-[10px] opacity-75 mt-1">{cell.freq} Hz</span>
                                                </>
                                            ) : (
                                                <span className="text-slate-300 text-xs font-mono opacity-50">
                                                    {idx < 3 ? 'HINGE' : idx < 6 ? 'TOP' : idx < 9 ? 'MID' : 'PALM'}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Safe area padding for iPhone Home Indicator */}
                        <div className="h-safe-bottom bg-white w-full"></div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LaptopNoiseAnalyzer />);
    </script>
</body>
</html>
