<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>筆電異音分析儀 (Laptop Noise Analyzer)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons Components (Inline SVG replacement for lucide-react) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Activity = (props) => (
            <IconBase {...props}>
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </IconBase>
        );

        const Play = (props) => (
            <IconBase {...props}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </IconBase>
        );

        const Square = (props) => (
            <IconBase {...props}>
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            </IconBase>
        );

        const RefreshCcw = (props) => (
            <IconBase {...props}>
                <path d="M3 2v6h6"></path>
                <path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path>
                <path d="M21 22v-6h-6"></path>
                <path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path>
            </IconBase>
        );

        const Mic = (props) => (
            <IconBase {...props}>
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </IconBase>
        );

        const MapPin = (props) => (
            <IconBase {...props}>
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </IconBase>
        );

        const Info = (props) => (
            <IconBase {...props}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </IconBase>
        );

        // --- Main Component ---
        const LaptopNoiseAnalyzer = () => {
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [decibels, setDecibels] = useState(-100);
            const [peakFreq, setPeakFreq] = useState(0);
            const [gain, setGain] = useState(1.0); // Software gain
            
            // Heatmap state
            // 3x4 grid representing a laptop base
            const [gridData, setGridData] = useState(Array(12).fill(null));
            
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const sourceRef = useRef(null);
            const rafIdRef = useRef(null);
            const canvasRef = useRef(null);
            const gainNodeRef = useRef(null);

            // Initialize Audio Context
            const startAnalysis = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    
                    const analyser = audioContextRef.current.createAnalyser();
                    analyser.fftSize = 2048;
                    analyserRef.current = analyser;

                    // Create Gain Node for sensitivity adjustment
                    const gainNode = audioContextRef.current.createGain();
                    gainNode.gain.value = gain;
                    gainNodeRef.current = gainNode;

                    const source = audioContextRef.current.createMediaStreamSource(stream);
                    source.connect(gainNode);
                    gainNode.connect(analyser); // Connect to analyser but NOT destination (to prevent feedback loop)
                    
                    sourceRef.current = source;
                    setIsAnalyzing(true);
                    drawSpectrum();
                } catch (err) {
                    console.error("Error accessing microphone:", err);
                    alert("無法存取麥克風，請確認瀏覽器權限，並確保使用 HTTPS 或 Localhost 環境。");
                }
            };

            const stopAnalysis = () => {
                if (audioContextRef.current) {
                    audioContextRef.current.close();
                }
                if (rafIdRef.current) {
                    cancelAnimationFrame(rafIdRef.current);
                }
                setIsAnalyzing(false);
                setDecibels(-100);
                setPeakFreq(0);
            };

            const updateGain = (val) => {
                setGain(val);
                if (gainNodeRef.current) {
                    gainNodeRef.current.gain.value = val;
                }
            };

            // Main Analysis Loop
            const drawSpectrum = () => {
                const canvas = canvasRef.current;
                if (!canvas || !analyserRef.current) return;

                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                analyserRef.current.getByteFrequencyData(dataArray);

                // 1. Draw Background
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(0, 0, width, height);

                // 2. Calculate Peak Frequency
                let maxVal = -Infinity;
                let maxIndex = 0;
                // Calculate RMS for dB
                let sum = 0;

                const barWidth = (width / bufferLength) * 2.5;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i];
                    
                    // Find Peak Frequency
                    if (v > maxVal) {
                        maxVal = v;
                        maxIndex = i;
                    }

                    // Sum for RMS (approximate)
                    sum += v * v;

                    // Draw Bar
                    const percent = v / 255;
                    const barHeight = height * percent;
                    
                    // Color based on frequency (Low: Blue, Mid: Green, High: Red)
                    const hue = (i / bufferLength) * 360; 
                    ctx.fillStyle = `hsl(${hue}, 70%, 50%)`;
                    ctx.fillRect(x, height - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }

                // Update React State for UI
                const rms = Math.sqrt(sum / bufferLength);
                const db = 20 * Math.log10(rms / 255); // Normalized roughly
                // Map -60dB to 0dB range for easier reading
                const displayDb = Math.max(-100, Math.round(db * 100) / 100); 
                
                setDecibels(displayDb);

                // Calculate actual frequency of the peak bin
                const nyquist = audioContextRef.current.sampleRate / 2;
                const frequency = maxIndex * (nyquist / bufferLength);
                setPeakFreq(Math.round(frequency));

                rafIdRef.current = requestAnimationFrame(drawSpectrum);
            };

            // Heatmap Logic
            const recordPoint = (index) => {
                if (!isAnalyzing) {
                    alert("請先開始分析 (Start Analysis)");
                    return;
                }
                
                const newGrid = [...gridData];
                // Scale dB to a 0-100 score for visualization context
                // Assuming typical noise floor -50dB, loud noise -10dB
                let intensity = (decibels + 60) * 2; 
                intensity = Math.max(0, Math.min(100, intensity));

                newGrid[index] = {
                    db: decibels,
                    freq: peakFreq,
                    intensity: intensity
                };
                setGridData(newGrid);
            };

            const clearGrid = () => {
                setGridData(Array(12).fill(null));
            };

            const getCellColor = (intensity) => {
                if (intensity === undefined || intensity === null) return 'bg-gray-100 hover:bg-gray-200';
                // Green to Red gradient
                if (intensity < 30) return 'bg-green-200 border-green-500 border-2';
                if (intensity < 60) return 'bg-yellow-200 border-yellow-500 border-2';
                return 'bg-red-300 border-red-600 border-2 animate-pulse';
            };

            return (
                <div className="flex flex-col h-screen bg-gray-50 p-4 font-sans text-slate-800">
                    <header className="mb-4 flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div>
                            <h1 className="text-xl font-bold flex items-center gap-2 text-slate-800">
                                <Activity className="text-blue-600" />
                                筆電機構異音分析儀
                            </h1>
                            <p className="text-sm text-slate-500">聲源定位與頻譜分析工具</p>
                        </div>
                        <div className="flex gap-2">
                            {!isAnalyzing ? (
                                <button 
                                    onClick={startAnalysis}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
                                >
                                    <Play size={18} /> 開始分析
                                </button>
                            ) : (
                                <button 
                                    onClick={stopAnalysis}
                                    className="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium"
                                >
                                    <Square size={18} /> 停止
                                </button>
                            )}
                        </div>
                    </header>

                    <div className="flex flex-col lg:flex-row gap-6 flex-1 overflow-hidden">
                        {/* Left Panel: Real-time Data */}
                        <div className="flex-1 flex flex-col gap-4">
                            {/* Signal Visualizer */}
                            <div className="bg-slate-900 rounded-xl p-4 shadow-lg flex-1 min-h-[250px] relative">
                                <canvas 
                                    ref={canvasRef} 
                                    width={600} 
                                    height={300} 
                                    className="w-full h-full object-cover rounded-lg opacity-90"
                                />
                                <div className="absolute top-4 left-4 text-green-400 font-mono text-sm bg-black/50 p-2 rounded">
                                    <div>主要頻率 (Peak Freq): <span className="text-xl font-bold text-white">{peakFreq} Hz</span></div>
                                    <div>相對強度 (Level): <span className="text-xl font-bold text-white">{decibels.toFixed(1)} dB</span></div>
                                </div>
                                
                                {!isAnalyzing && (
                                    <div className="absolute inset-0 flex items-center justify-center text-slate-400">
                                        <p>點擊「開始分析」以啟動麥克風</p>
                                    </div>
                                )}
                            </div>

                            {/* Controls */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                <div className="flex items-center gap-4 mb-2">
                                    <span className="font-bold text-sm text-slate-600">麥克風增益 (Sensitivity Gain):</span>
                                    <input 
                                        type="range" 
                                        min="0.5" 
                                        max="5.0" 
                                        step="0.1" 
                                        value={gain} 
                                        onChange={(e) => updateGain(parseFloat(e.target.value))}
                                        className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                    <span className="text-sm font-mono bg-slate-100 px-2 py-1 rounded w-12 text-center">{gain}x</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-2">
                                    <Info size={12} className="inline mr-1"/>
                                    若波形太小請增加增益。若出現削波(Clipping)請降低增益。
                                </p>
                            </div>
                        </div>

                        {/* Right Panel: Manual Heatmap */}
                        <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col">
                            <div className="flex justify-between items-center mb-4">
                                <div>
                                    <h2 className="font-bold text-lg flex items-center gap-2">
                                        <MapPin className="text-red-500" />
                                        異音熱力定位圖 (C-Cover View)
                                    </h2>
                                    <p className="text-xs text-slate-500">將麥克風移至對應位置後，點擊方格記錄數值</p>
                                </div>
                                <button 
                                    onClick={clearGrid}
                                    className="flex items-center gap-1 text-xs px-3 py-1.5 bg-slate-100 text-slate-600 rounded hover:bg-slate-200"
                                >
                                    <RefreshCcw size={14} /> 重置
                                </button>
                            </div>

                            {/* Laptop Grid Representation */}
                            <div className="flex-1 relative flex items-center justify-center bg-slate-50 rounded-xl border border-dashed border-slate-300 p-8">
                                {/* Outline of laptop */}
                                <div className="w-full max-w-md aspect-[4/3] grid grid-cols-3 grid-rows-4 gap-2 relative">
                                    
                                    {/* Labels for guidance */}
                                    <div className="absolute -left-8 top-0 bottom-0 flex flex-col justify-between py-6 text-xs text-slate-400 font-mono">
                                        <span>Screen Hinge</span>
                                        <span>Keyboard Top</span>
                                        <span>Keyboard Bot</span>
                                        <span>Palmrest</span>
                                    </div>

                                    {gridData.map((cell, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => recordPoint(idx)}
                                            className={`relative rounded-lg transition-all duration-200 flex flex-col items-center justify-center p-2 group ${getCellColor(cell?.intensity)}`}
                                        >
                                            {cell ? (
                                                <>
                                                    <span className="font-bold text-slate-800 text-lg">{cell.db.toFixed(0)}</span>
                                                    <span className="text-[10px] text-slate-600">{cell.freq} Hz</span>
                                                </>
                                            ) : (
                                                <Mic size={24} className="text-slate-300 group-hover:text-blue-400 transition-colors" />
                                            )}
                                            
                                            {/* Hover Tooltip */}
                                            <div className="absolute -top-8 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-10">
                                                {idx < 3 ? "螢幕轉軸/散熱孔" : idx < 6 ? "鍵盤上半部/CPU" : idx < 9 ? "鍵盤下半部" : "手托/觸控板/電池"}區
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="mt-4 grid grid-cols-3 gap-2 text-xs text-center text-slate-500">
                                <div className="flex items-center justify-center gap-1"><div className="w-3 h-3 bg-green-200 rounded"></div> 安全/低噪音</div>
                                <div className="flex items-center justify-center gap-1"><div className="w-3 h-3 bg-yellow-200 rounded"></div> 疑似異音</div>
                                <div className="flex items-center justify-center gap-1"><div className="w-3 h-3 bg-red-300 rounded"></div> 高噪音熱點</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LaptopNoiseAnalyzer />);
    </script>
</body>
</html>
