<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>筆電異音分析儀 Pro (Laptop Noise Analyzer)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none; 
            background-color: #0f172a; /* Dark theme */
            color: #e2e8f0;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        canvas {
            image-rendering: pixelated; 
        }
    </style>
</head>
<body class="h-[100dvh] w-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full w-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons ---
        const IconBase = ({ children, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Activity = (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>;
        const Play = (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>;
        const Square = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></IconBase>;
        const FilterIcon = (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></IconBase>;
        const MaxHoldIcon = (p) => <IconBase {...p}><path d="M12 3v18"/><path d="M5 9l7-6 7 6"/><path d="M5 15l7 6 7-6"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></IconBase>;
        const Mic = (p) => <IconBase {...p}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></IconBase>;
        const RefreshCcw = (p) => <IconBase {...p}><path d="M3 2v6h6"></path><path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path><path d="M21 22v-6h-6"></path><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path></IconBase>;

        // --- Main Component ---
        const LaptopNoiseAnalyzer = () => {
            // General State
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [activeTab, setActiveTab] = useState('spectrum'); 
            const [decibels, setDecibels] = useState(-100);
            const [peakFreq, setPeakFreq] = useState(0);
            const [gain, setGain] = useState(2.0);
            const [filterEnabled, setFilterEnabled] = useState(true);
            
            // Max Hold State
            const [maxHold, setMaxHold] = useState(false);
            const [maxRecordedDb, setMaxRecordedDb] = useState(-100);
            const [isMaxFlashing, setIsMaxFlashing] = useState(false); // New: Controls flash effect

            // Heatmap State
            const [gridData, setGridData] = useState(Array(12).fill(null));
            
            // Refs
            const audioContextRef = useRef(null);
            const analyserRef = useRef(null);
            const rafIdRef = useRef(null);
            const sourceRef = useRef(null);
            const filterNodeRef = useRef(null);
            const gainNodeRef = useRef(null);
            
            // Refs for loop state (Solving Stale Closure)
            const maxHoldRef = useRef(false);
            const maxDbRef = useRef(-100);
            
            // Canvas Refs
            const spectrumCanvasRef = useRef(null);
            const spectrogramCanvasRef = useRef(null);
            const containerRef = useRef(null);

            // Data Refs
            const maxHoldDataRef = useRef(new Uint8Array(512));
            
            // Sync maxHold state to ref for the animation loop
            useEffect(() => {
                maxHoldRef.current = maxHold;
                if (!maxHold) {
                    resetMaxHold();
                }
            }, [maxHold]);

            // --- Helper: Resize Canvas ---
            const handleResize = useCallback(() => {
                if (activeTab === 'spectrum' && containerRef.current && spectrumCanvasRef.current && spectrogramCanvasRef.current) {
                    const w = containerRef.current.clientWidth;
                    const totalH = containerRef.current.clientHeight;
                    
                    if (totalH === 0) return;

                    spectrumCanvasRef.current.width = w;
                    spectrumCanvasRef.current.height = Math.floor(totalH * 0.4);
                    
                    spectrogramCanvasRef.current.width = w;
                    spectrogramCanvasRef.current.height = Math.floor(totalH * 0.6);
                    
                    const ctx = spectrogramCanvasRef.current.getContext('2d');
                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(0, 0, w, totalH * 0.6);
                }
            }, [activeTab]);

            useEffect(() => {
                window.addEventListener('resize', handleResize);
                setTimeout(handleResize, 100);
                return () => window.removeEventListener('resize', handleResize);
            }, [handleResize]);

            useEffect(() => {
                if (activeTab === 'spectrum') {
                    requestAnimationFrame(handleResize);
                }
            }, [activeTab, handleResize]);


            // --- Audio Logic ---
            const startAnalysis = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
                    });
                    
                    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                    const ctx = audioContextRef.current;

                    const analyser = ctx.createAnalyser();
                    analyser.fftSize = 1024; 
                    analyser.smoothingTimeConstant = 0.2; 
                    analyserRef.current = analyser;
                    
                    // Reset Max Hold Stats
                    maxHoldDataRef.current = new Uint8Array(analyser.frequencyBinCount);
                    setMaxRecordedDb(-100);
                    maxDbRef.current = -100; // Reset loop ref
                    setIsMaxFlashing(false);

                    const filter = ctx.createBiquadFilter();
                    filter.type = 'highpass';
                    filter.frequency.value = filterEnabled ? 200 : 0;
                    filterNodeRef.current = filter;

                    const gainNode = ctx.createGain();
                    gainNode.gain.value = gain;
                    gainNodeRef.current = gainNode;

                    const source = ctx.createMediaStreamSource(stream);
                    sourceRef.current = source;

                    source.connect(filter);
                    filter.connect(gainNode);
                    gainNode.connect(analyser);
                    
                    setIsAnalyzing(true);
                    draw();
                } catch (err) {
                    console.error(err);
                    alert("麥克風存取失敗，請確認權限。");
                }
            };

            const stopAnalysis = () => {
                if (audioContextRef.current) audioContextRef.current.close();
                if (rafIdRef.current) cancelAnimationFrame(rafIdRef.current);
                setIsAnalyzing(false);
            };

            const toggleFilter = () => {
                const newState = !filterEnabled;
                setFilterEnabled(newState);
                if (filterNodeRef.current && audioContextRef.current) {
                    filterNodeRef.current.frequency.setTargetAtTime(newState ? 200 : 0, audioContextRef.current.currentTime, 0.1);
                }
            };

            const resetMaxHold = () => {
                if (analyserRef.current) {
                    maxHoldDataRef.current = new Uint8Array(analyserRef.current.frequencyBinCount);
                }
                setMaxRecordedDb(-100);
                maxDbRef.current = -100; // Important: reset the comparison ref
                setIsMaxFlashing(false);
            };

            const updateGain = (val) => {
                setGain(val);
                if (gainNodeRef.current) gainNodeRef.current.gain.value = val;
            };

            // --- Heatmap Logic ---
            const recordPoint = (index) => {
                if (!isAnalyzing) {
                    alert("請先點擊上方「開始量測」");
                    return;
                }
                const newGrid = [...gridData];
                let intensity = (decibels + 60) * 2; 
                intensity = Math.max(0, Math.min(100, intensity));

                newGrid[index] = {
                    db: decibels,
                    freq: peakFreq,
                    intensity: intensity
                };
                setGridData(newGrid);
            };

            const clearGrid = () => setGridData(Array(12).fill(null));

            const getCellStyles = (cell) => {
                const base = "relative w-full h-full rounded-xl flex flex-col items-center justify-center transition-all duration-200 active:scale-95 touch-manipulation shadow-sm ";
                if (!cell) return base + "bg-slate-800 border-2 border-dashed border-slate-600 active:border-sky-400 active:bg-slate-700";
                
                const { intensity } = cell;
                if (intensity < 30) return base + "bg-emerald-900/80 border-2 border-emerald-500 text-emerald-100";
                if (intensity < 60) return base + "bg-yellow-900/80 border-2 border-yellow-500 text-yellow-100";
                return base + "bg-rose-900/80 border-2 border-rose-500 text-rose-100 animate-pulse";
            };

            // --- Drawing Loop ---
            const draw = () => {
                if (!analyserRef.current) return;
                
                const bufferLength = analyserRef.current.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyserRef.current.getByteFrequencyData(dataArray);

                let maxVal = 0;
                let maxIndex = 0;
                let sum = 0;
                
                const isMaxHoldOn = maxHoldRef.current; // Use ref for current loop iteration

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i];
                    
                    if (isMaxHoldOn && v > maxHoldDataRef.current[i]) {
                        maxHoldDataRef.current[i] = v;
                    }

                    if (v > maxVal) { maxVal = v; maxIndex = i; }
                    sum += v * v;
                }

                // Update UI Numbers
                const rms = Math.sqrt(sum / bufferLength);
                const db = 20 * Math.log10(rms / 255);
                const currentDb = Math.max(-100, Math.round(db * 10) / 10);
                setDecibels(currentDb);
                
                // Track Max dB with Flash logic
                if (isMaxHoldOn) {
                    if (currentDb > maxDbRef.current) {
                        maxDbRef.current = currentDb;
                        setMaxRecordedDb(currentDb);
                        
                        // Trigger Flash
                        setIsMaxFlashing(true);
                        setTimeout(() => setIsMaxFlashing(false), 200); // 200ms flash
                    }
                }

                const nyquist = audioContextRef.current.sampleRate / 2;
                setPeakFreq(Math.round(maxIndex * (nyquist / bufferLength)));

                // 2. Draw Spectrum
                if (activeTab === 'spectrum' && spectrumCanvasRef.current) {
                    const ctx = spectrumCanvasRef.current.getContext('2d');
                    const w = spectrumCanvasRef.current.width;
                    const h = spectrumCanvasRef.current.height;

                    ctx.fillStyle = '#0f172a';
                    ctx.fillRect(0, 0, w, h);

                    // Grid
                    ctx.strokeStyle = '#334155';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    for(let i=1; i<4; i++) {
                        let y = h * (i/4);
                        ctx.moveTo(0, y);
                        ctx.lineTo(w, y);
                    }
                    ctx.stroke();

                    // Real-time Line
                    ctx.beginPath();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#38bdf8'; 
                    const sliceWidth = w * 1.0 / bufferLength;
                    let x = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        const y = h - (dataArray[i] / 255.0 * h);
                        if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                        x += sliceWidth;
                    }
                    ctx.stroke();

                    // Max Hold Line
                    if (isMaxHoldOn) {
                        ctx.beginPath();
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = '#facc15'; 
                        ctx.setLineDash([2, 2]);
                        x = 0;
                        for(let i = 0; i < bufferLength; i++) {
                            const y = h - (maxHoldDataRef.current[i] / 255.0 * h);
                            if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                            x += sliceWidth;
                        }
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                }

                // 3. Draw Spectrogram
                if (activeTab === 'spectrum' && spectrogramCanvasRef.current) {
                    const ctx = spectrogramCanvasRef.current.getContext('2d');
                    const w = spectrogramCanvasRef.current.width;
                    const h = spectrogramCanvasRef.current.height;

                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = w;
                    tempCanvas.height = h;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(spectrogramCanvasRef.current, 0, 0);
                    ctx.drawImage(tempCanvas, 0, 1);

                    const imgData = ctx.createImageData(w, 1);
                    for (let x = 0; x < w; x++) {
                        const i = Math.floor((x / w) * bufferLength);
                        const value = dataArray[i];
                        
                        const r = value > 150 ? 255 : value * 1.5;
                        const g = value > 200 ? 255 : (value > 100 ? (value-100)*2 : 0);
                        const b = value < 100 ? value * 2 : (255 - (value-100));
                        
                        const idx = x * 4;
                        imgData.data[idx] = r; imgData.data[idx+1] = g; imgData.data[idx+2] = b; imgData.data[idx+3] = 255;
                    }
                    ctx.putImageData(imgData, 0, 0);
                }

                rafIdRef.current = requestAnimationFrame(draw);
            };

            return (
                <div className="flex flex-col h-full w-full select-none text-slate-200 bg-slate-900">
                    
                    {/* 1. Top Header & Controls */}
                    <div className="flex-none bg-slate-900 border-b border-slate-700 p-3 flex flex-col gap-3 z-20 shadow-md">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <Activity className="text-sky-400" size={20}/>
                                <div>
                                    <h1 className="font-bold text-sm leading-none">機構異音分析 Pro</h1>
                                    <div className="text-[10px] text-slate-400 mt-0.5">Dual Mode Analyzer</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                 {!isAnalyzing ? (
                                    <button onClick={startAnalysis} className="flex items-center gap-1 bg-sky-600 active:bg-sky-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-sky-900/50 transition-all">
                                        <Play size={16}/> 開始
                                    </button>
                                 ) : (
                                    <button onClick={stopAnalysis} className="flex items-center gap-1 bg-rose-600 active:bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-rose-900/50 transition-all">
                                        <Square size={16}/> 停止
                                    </button>
                                 )}
                            </div>
                        </div>

                        {/* Toolbar (Shared) */}
                        <div className="flex items-center justify-between gap-2 overflow-x-auto no-scrollbar">
                            <div className="flex gap-2">
                                <button onClick={toggleFilter} className={`flex items-center gap-1.5 px-3 py-1.5 rounded text-xs border transition-all ${filterEnabled ? 'bg-emerald-900/50 border-emerald-500 text-emerald-400' : 'bg-slate-800 border-slate-600 text-slate-400'}`}>
                                    <FilterIcon size={14}/> {filterEnabled ? "濾波 (>200Hz)" : "全頻段"}
                                </button>
                                <button onClick={() => { setMaxHold(!maxHold); }} className={`flex items-center gap-1.5 px-3 py-1.5 rounded text-xs border transition-all ${maxHold ? 'bg-yellow-900/50 border-yellow-500 text-yellow-400' : 'bg-slate-800 border-slate-600 text-slate-400'}`}>
                                    <MaxHoldIcon size={14}/> 峰值: {maxHold ? "ON" : "OFF"}
                                </button>
                                {maxHold && <button onClick={resetMaxHold} className="p-1.5 bg-slate-800 border border-slate-600 rounded text-slate-300 active:bg-slate-700"><Trash2 size={14}/></button>}
                            </div>
                            <div className="flex items-center gap-2 bg-slate-800/80 px-2 py-1.5 rounded border border-slate-700">
                                <span className="text-[10px] font-mono text-slate-400 whitespace-nowrap">GAIN {gain.toFixed(1)}x</span>
                                <input type="range" min="0.5" max="10.0" step="0.5" value={gain} onChange={(e) => updateGain(parseFloat(e.target.value))} className="w-16 h-1 bg-slate-600 appearance-none rounded cursor-pointer accent-sky-400"/>
                            </div>
                        </div>
                    </div>

                    {/* 2. Main Content Area (Switchable) */}
                    <div className="flex-1 relative overflow-hidden bg-slate-950">
                        
                        {/* --- View A: Spectrum Analyzer --- */}
                        <div className={`absolute inset-0 flex flex-col ${activeTab === 'spectrum' ? 'z-10 visible' : 'z-0 invisible'}`} ref={containerRef}>
                            <canvas ref={spectrumCanvasRef} className="block w-full flex-none" />
                            <div className="h-[1px] bg-slate-700 w-full flex-none"></div>
                            <canvas ref={spectrogramCanvasRef} className="block w-full flex-1" />
                            
                            {/* Overlay Stats */}
                            <div className="absolute top-2 right-2 flex flex-col items-end gap-1 pointer-events-none">
                                <div className="text-2xl font-bold font-mono text-white drop-shadow-md">
                                    {decibels.toFixed(1)} <span className="text-sm text-slate-400">dB</span>
                                </div>
                                <div className="text-xs font-mono text-sky-300 bg-sky-900/40 px-1.5 py-0.5 rounded border border-sky-800 backdrop-blur-sm">
                                    Peak: {peakFreq} Hz
                                </div>
                                {maxHold && (
                                    <div className={`text-sm font-bold font-mono px-2 py-0.5 rounded border backdrop-blur-sm mt-1 transition-all duration-100 ${
                                        isMaxFlashing 
                                        ? "bg-yellow-400 text-slate-900 border-yellow-400 scale-105 shadow-[0_0_10px_rgba(250,204,21,0.5)]" 
                                        : "text-yellow-400 bg-yellow-900/40 border-yellow-700"
                                    }`}>
                                        Max: {maxRecordedDb.toFixed(1)} dB
                                    </div>
                                )}
                            </div>
                            
                            {/* Labels */}
                            <div className="absolute top-2 left-2 text-[10px] font-mono text-sky-400 bg-black/40 px-1 rounded pointer-events-none">即時頻譜</div>
                            <div className="absolute bottom-2 left-2 text-[10px] font-mono text-orange-400 bg-black/40 px-1 rounded pointer-events-none">瀑布圖 (時間軸)</div>
                        </div>

                        {/* --- View B: Heatmap (Grid) --- */}
                        <div className={`absolute inset-0 flex flex-col p-4 overflow-y-auto no-scrollbar ${activeTab === 'heatmap' ? 'z-10 visible' : 'z-0 invisible'}`}>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-sm font-bold text-slate-300 flex items-center gap-2">
                                    <MapPin className="text-rose-500" size={16}/> 異音熱點定位
                                </h2>
                                <button onClick={clearGrid} className="text-xs flex items-center gap-1 text-slate-400 bg-slate-800 px-2 py-1 rounded hover:bg-slate-700">
                                    <RefreshCcw size={12}/> 重置
                                </button>
                            </div>

                            <div className="w-full max-w-sm mx-auto aspect-[3/4] grid grid-cols-3 grid-rows-4 gap-2">
                                {gridData.map((cell, idx) => (
                                    <div key={idx} onClick={() => recordPoint(idx)} className={getCellStyles(cell)}>
                                        {cell ? (
                                            <>
                                                <span className="text-xl font-bold leading-none">{cell.db.toFixed(0)}</span>
                                                <span className="text-[10px] opacity-75 mt-1">{cell.freq} Hz</span>
                                            </>
                                        ) : (
                                            <div className="flex flex-col items-center opacity-30">
                                                <Mic size={16}/>
                                                <span className="text-[9px] font-mono mt-1">
                                                    {idx < 3 ? 'HINGE' : idx < 6 ? 'TOP' : idx < 9 ? 'MID' : 'PALM'}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <div className="mt-4 text-center text-xs text-slate-500">
                                點擊方格以紀錄當前 dB 與頻率
                            </div>
                        </div>

                    </div>

                    {/* 3. Bottom Tabs */}
                    <div className="flex-none bg-slate-900 border-t border-slate-700 pb-safe">
                        <div className="flex">
                            <button 
                                onClick={() => setActiveTab('spectrum')}
                                className={`flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-bold transition-colors ${activeTab === 'spectrum' ? 'text-sky-400 bg-slate-800 border-t-2 border-sky-400' : 'text-slate-500 border-t-2 border-transparent'}`}
                            >
                                <Activity size={20} />
                                頻譜分析
                            </button>
                            <div className="w-[1px] bg-slate-800 my-2"></div>
                            <button 
                                onClick={() => setActiveTab('heatmap')}
                                className={`flex-1 py-3 flex flex-col items-center gap-1 text-[10px] font-bold transition-colors ${activeTab === 'heatmap' ? 'text-rose-400 bg-slate-800 border-t-2 border-rose-400' : 'text-slate-500 border-t-2 border-transparent'}`}
                            >
                                <MapPin size={20} />
                                異音定位
                            </button>
                        </div>
                    </div>

                    {!isAnalyzing && (
                        <div className="absolute inset-0 top-32 bottom-20 flex items-center justify-center pointer-events-none z-30">
                            <div className="bg-black/60 backdrop-blur-sm px-4 py-2 rounded-full border border-slate-600 text-slate-300 text-xs animate-pulse">
                                請點擊左上角「開始」
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LaptopNoiseAnalyzer />);
    </script>
</body>
</html>
